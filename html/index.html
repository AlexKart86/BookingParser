<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
</head>


  <body>
  <link rel="stylesheet" href="bower_components/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css" />
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="html/typeaheadjs.css" />
  <div class="container container-table">
      <div class="row vertical-center-row">
            <form class="form-inline">
              <div class="form-group">
                <input class="selectpicker form-control" id="station_from" placeholder="Станция отправления"> </input>
              </div>sss
              <div class="form-group">
                <input class="selectpicker form-control" id="station_to" placeholder="Станция назначения"> </input>
              </div>
              <div class="form-group">
                <label for="dtp">Дата</label>
                <div class="input-group date" id="dtp">
                  <input type="text" class="form-control" id="dtp_value"><span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span></span>
                </div>
              </div>
              <div class="form-group">
                  <button type="button" class="btn btn-primary" id="start">Отслеживать</button>
              </div>
              <div class="form-group">
                    <button type="button" class="btn btn-danger" id="stop" hidden="hidden">Прекратить отслеживать</button>
              </div>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" id="start_ex">Сильно отслеживать</button>
                </div>
              <div class="container">
                  <div>Обновлено: <span id="upd_time"></span></div>
                  <table class="table">
                      <thead>
                         <tr>
                             <th>Поезд</th>
                             <th>Отправление</th>
                             <th>Прибытие</th>
                             <th>Места</th>
                         </tr>
                      </thead>
                      <tbody id="results">

                      </tbody>
                  </table>
              </div>
            </form>
       </div>
  </div>
    <script src="bower_components/moment/min/moment-with-locales.min.js"></script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <script src="bower_components/typeahead.js/dist/typeahead.jquery.min.js"></script>

  <script>
    var station_list = {};
    var is_running = false;
    var check_interval = 10000;

    function display_train(train){
       var main_div = document.createElement("tr");
       var seats = "";
       $.each(train.types, function(idx, data){
         seats += data.title + ": <b>" + data.places + "</b><br/>";
       });
       $('#results').append($('<tr>'+
                '<td>' + train.num+ '</td>' +
                '<td>' + train.from.src_date +'</td>' +
                '<td>' + train.till.src_date +'</td>' +
                '<td>'+seats +'</td>' +
               '</tr>'));
    }

    function display_results(data){
        $('#results').empty();
        $.each(data, function(idx, element){
            display_train(element);
        });
        $('#upd_time').html(new Date().toLocaleTimeString());
    }

    var load_station_list = function(query, syncResult, asyncResult){
        $.ajax({
            url: "/get_stations",
            method: "POST",
            data: JSON.stringify({"name": query}),
            contentType: 'application/json',
            dataType: "json",
            success: function (data) {
                //console.log(data);
                $.each(data, function(idx, dt){
                     //console.log(dt);
                     station_list[dt.title] = dt.station_id;
                });
                asyncResult(data);
            }
        })
    };

    function search_iteration(station_from, station_to, dt){
        $.ajax({
            url: "/find_trains",
            method: "POST",
            data: JSON.stringify({
                "station_from": station_from,
                "station_to": station_to,
                "date": dt
            }),
            contentType: 'application/json',
            dataType: "json",
            success: function(data){
                console.log(data);
                display_results(data);
                if (is_running)
                    timerID = setTimeout(function () {
                     search_iteration(station_from, station_to, dt);
                  }, check_interval);
            },
            //Обрабатываем ошибку 400
            statusCode: {
                400: function(){
                    if (is_running)
                        timerID = setTimeout(function () {
                            search_iteration(station_from, station_to, dt);
                        }, check_interval);
                }
            }
        });
    }


    $(function(){
      $('#stop').hide();
      $('#dtp').datetimepicker({
        locale: 'ru',
        format: 'DD.MM.YYYY'
      });
      $('#station_from, #station_to').typeahead({
        minLength: 2,
        highlight: true
      }, {
        source: load_station_list,
        display: 'title'
      });


      $('#start_ex').on('click', function() {
                  var station_from = station_list[$('#station_from').val()];
                  var station_to = station_list[$('#station_to').val()];
                  var dt = $('#dtp_value').val();
                  $.ajax({
                      url: "/find_trains_ex",
                      method: "POST",
                      data: JSON.stringify({
                          "station_from": station_from,
                          "station_to": station_to,
                          "date": dt
                      }),
                      contentType: 'application/json',
                      dataType: "json",
                      success: function (data) {
                          console.log(data);
                      }
                  });
              }
          );

      $('#start').on('click', function(){
        var station_from = station_list[$('#station_from').val()];
        var station_to = station_list[$('#station_to').val()];
        var dt = $('#dtp_value').val();

        if (!station_from) {
            alert("Херня в станции отправления");
            return;
        }
        if (!station_to) {
            alert("Херня в станции назначения");
            return;
        }
        //alert($('#dtp_value').val());
        if (dt.length == 0){
            alert("Херня в дате");
            return;
        }
        $('#start').hide();
        $('#stop').show();
        //Запускаем
        is_running = true;
        timerID = setTimeout(function(){
              search_iteration(station_from, station_to, dt);
          }, 0);
      });

      $('#stop').on('click', function(){
          clearInterval(timerID);
          timerID = "";
          is_running = false;
          $('#stop').hide();
          $('#start').show();
      })
    })
  </script>
  <style>
      html, body, .container-table {
          height: 100%;
          margin: 10px;
      }
      .form-inline > * {
          margin:5px;
      }
  </style>

  </body>

</html>